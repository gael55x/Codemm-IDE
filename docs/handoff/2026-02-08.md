# Handoff: 2026-02-08

## Summary

- Continued Phase 3 (packaging + determinism hardening).
- Threads persistence is now explicitly `threads*` in SQLite (legacy `sessions*` workspaces migrate in-place on startup).
- Generation progress is replayable from persisted `runs`/`run_events` (not just in-memory buffers).

## Iteration Log

### Iteration 1 (IPC Hardening + Packaged Engine)

- Electron main adds zod-based IPC payload validation for `threads/*`, `activities/*`, and secrets (`apps/ide/main.js`).
- Electron main adds zod-based IPC payload validation for `judge/*` (`apps/ide/main.js`).
- Packaged runs force the engine to load compiled `dist` (`CODEMM_ENGINE_USE_DIST=1`) (`apps/ide/main.js`, `apps/backend/ipc-server.js`).

### Iteration 2 (Troubleshooting)

- Documented native module ABI mismatch fixes (`better-sqlite3`) and SQLite schema-init recovery (`docs/TROUBLESHOOTING.md`).

### Iteration 3 (Packaging Determinism)

- `npm run dist:mac` now rebuilds native deps for Electron automatically (`npm run rebuild:electron`) to avoid `better-sqlite3` ABI issues in packaged runs (`package.json`).

### Iteration 4 (Custom Instructions + Activities API)

- Persist per-thread `instructions_md` in `threads` (best-effort generation shaping; no secrets) (`apps/backend/src/database.ts`, `apps/backend/src/services/sessionService.ts`).
- Generation prompts now receive `customInstructionsMd` via prompt context across languages (`apps/backend/src/generation/index.ts`, `apps/backend/src/languages/*/prompts.ts`).
- Added engine RPC: `threads.setInstructions`, `activities.list` (summaries) (`apps/backend/src/ipcServer.ts`, `apps/backend/src/database.ts`).

### Iteration 5 (IDE Bridge)

- Exposed `threads.setInstructions` and `activities.list` via Electron IPC + preload allowlist (`apps/ide/main.js`, `apps/ide/preload.js`).

### Iteration 6 (Renderer UX)

- Added “Problem focus (optional)” instructions panel in chat UI (stored per-thread; used during generation) (`apps/frontend/src/app/page.tsx`).
- Added local “Your activities” page + header navigation (`apps/frontend/src/app/activities/page.tsx`, `apps/frontend/src/app/page.tsx`).
- Updated renderer docs to reflect IPC-only IDE-first flows (removed community/auth HTTP docs) (`apps/frontend/docs/*`).

### Iteration 7 (Docs)

- Documented new renderer APIs (`threads.setInstructions`, `activities.list`) and thread-level `instructions_md` (`apps/frontend/docs/api/frontend.md`, `docs/architecture/IDE_FIRST.md`).

### Iteration 8 (Renderer UX Polish)

- Restyled `/activities` to match the main app’s theme (dark mode, card styling, button styles) and added client-side search (`apps/frontend/src/app/activities/page.tsx`).

### Iteration 9 (Security Hardening)

- Mitigated localhost UI port hijacking by verifying an ephemeral frontend boot token via `GET /codemm/health` before loading the renderer URL (`apps/ide/main.js`, `apps/frontend/src/app/codemm/health/route.ts`, `docs/SECURITY.md`).

### Iteration 10 (README Refresh)

- Rewrote `README.md` to be an IDE-first documentation entrypoint (mental model, topology, persistence, security model, packaging, docs index).

### Iteration 11 (Judge Hardening)

- Ensured Java `/run` executes in Docker with network disabled and read-only rootfs (consistent with other languages) (`apps/backend/src/languages/java/run.ts`).

### Iteration 12 (Docs Hygiene)

- Updated `CONTRIBUTING.md` to reflect IPC-only engine (no Express/SSE) and IDE-first runtime (`CONTRIBUTING.md`).

### Iteration 13 (Local LLM + Electron Hardening)

- Added `ollama` as an LLM provider option (no API key; local model name) and wired it through secrets + engine provider selection (`apps/ide/main.js`, `apps/frontend/src/app/settings/llm/page.tsx`, `apps/backend/src/infra/llm/adapters/ollama.ts`).
- Hardened Electron renderer navigation (deny permission prompts; block navigations away from the expected local frontend origin; bind dev frontend to `127.0.0.1`) (`apps/ide/main.js`).

### Iteration 14 (Secrets Hardening)

- Stopped passing API keys to the engine via environment variables; Electron now configures the engine LLM provider in-memory via `engine.configureLlm` over IPC (`apps/ide/main.js`, `apps/backend/src/ipcServer.ts`, `apps/backend/src/infra/llm/runtimeConfig.ts`).

### Iteration 15 (Docs)

- Updated docs for Ollama + in-memory LLM configuration (`README.md`, `docs/FUNCTIONS.md`, `docs/TROUBLESHOOTING.md`).

### Iteration 16 (UX Copy)

- Renamed settings copy from “API key” to “LLM settings” where applicable (supports Ollama local provider) (`apps/frontend/src/app/settings/llm/page.tsx`, `apps/ide/main.js`).

### Iteration 17 (Cross-Platform Scaffolding)

- Added Windows + Linux targets to `electron-builder.yml` and build scripts (`npm run dist:win`, `npm run dist:linux`) (`electron-builder.yml`, `package.json`).
- Made Docker discovery more reliable cross-platform (don’t assume `docker` exists on PATH; improved error reasons) and added Windows-safe process-tree termination (`apps/ide/main.js`).

### Iteration 18 (Ollama Auto-Ensure + Live LLM Apply)

- Added an Ollama “ensure + pull model” flow that can start `ollama serve` (best-effort) and run `ollama pull <model>` from inside the desktop app, streaming pull logs to the UI (`apps/ide/main.js`, `apps/ide/preload.js`, `apps/frontend/src/app/settings/llm/page.tsx`).
- LLM settings changes now apply to the running engine immediately via `engine.configureLlm` (restart no longer required for new runs) (`apps/ide/main.js`).

### Iteration 19 (Judge Execution Hardening)

- Removed shell-based `child_process.exec()` for Docker execution; judge and `/run` now call Docker via `spawn()` with argument arrays (fixes Windows path issues and reduces command-injection surface) (`apps/backend/src/judge/docker.ts`, `apps/backend/src/languages/*/*`).
- Added safe user-file writing to temporary directories to prevent path traversal when users provide multi-file submissions (`apps/backend/src/judge/files.ts`, `apps/backend/src/languages/*/*`).

### Iteration 20 (Codemm-Desktop Naming + Docs Refresh)

- Updated user-facing naming and docs to “Codemm-Desktop” (README, core docs, UI error messages, Electron loading screen) (`README.md`, `docs/*`, `apps/*/README.md`, `apps/frontend/docs/*`, `apps/ide/main.js`).
- Updated docs to reflect current Ollama flow (in-app ensure/pull) and live LLM apply (no restart needed for new runs) (`README.md`, `docs/TROUBLESHOOTING.md`, `docs/architecture/IDE_FIRST.md`).

### Iteration 21 (Practice Activity UX: 3-Panel Layout)

- Reworked the practice activity screen into a clear 3-panel structure:
  - left: active problem context only (description + constraints + **always-visible examples**)
  - center: editor + run controls (editor state restores per problem)
  - right: progress list (problem statuses) + persistent feedback panel (last run persists across problem switches; user can clear) (`apps/frontend/src/app/activity/[id]/page.tsx`).

### Iteration 22 (Practice Activity UX: Editor State Robustness)

- Ensured per-problem editor state restoration is resilient to rapid switching (update refs on change/file-switch/add-file so switching problems reliably restores last editor + active file) (`apps/frontend/src/app/activity/[id]/page.tsx`).

### Iteration 23 (Ollama Install Link Robustness)

- Fixed `codemm:ollama:openInstall` handler registration so it’s always available (registered early in Electron main), and made the renderer resilient if a handler is missing (fallback to opening the download page directly) (`apps/ide/main.js`, `apps/ide/preload.js`, `apps/frontend/src/app/settings/llm/page.tsx`).

### Iteration 24 (Fix: Missing `openInstall` Handler Crash)

- Eliminated `ipcRenderer.invoke()` dependency for opening the Ollama download link (use `ipcRenderer.send()` + an `ipcMain.on(...)` listener), so “Install Ollama” cannot crash with “No handler registered” (`apps/ide/main.js`, `apps/ide/preload.js`).
- Made the renderer always fall back to `window.open("https://ollama.com/download")` when the IDE bridge is missing or returns an error (`apps/frontend/src/app/settings/llm/page.tsx`).

### Iteration 25 (Generation Robustness: Retries + Timeout)

- Increased per-slot activity generation retries from 3 → 5 (helps with flaky reference-solution validation) (`apps/backend/src/generation/index.ts`).
- Increased Electron→engine RPC timeout from 2m → 10m to avoid spurious `threads.generate` timeouts during long generations (reduces “GENERATING/READY” mismatch loops) (`apps/ide/main.js`).

### Iteration 26 (Fix: Frontend Health Route 404)

- Renamed the frontend health route from `/__codemm/health` → `/codemm/health` because Next.js treats underscore-prefixed route segments as “private” and returns 404 (unblocked Electron’s readiness check) (`apps/ide/main.js`, `apps/frontend/src/app/codemm/health/route.ts`).

### Iteration 27 (Dev Boot: Avoid EADDRINUSE on Frontend Port)

- In dev, Electron now always probes for an available localhost frontend port and starts Next with explicit `-p <port> -H 127.0.0.1` args (prevents `EADDRINUSE` on `3000` and keeps the renderer bound to loopback) (`apps/ide/main.js`).

### Iteration 28 (Practice Activity: Replace `prompt()` with Modal)

- Replaced `window.prompt()` (unsupported in Next dev overlay) with an in-app “Add file” modal; validates filenames per language and updates the active workspace without crashing the UI (`apps/frontend/src/app/activity/[id]/page.tsx`).

### Iteration 29 (Practice Activity: Resizable 3-Pane Layout)

- Made the practice activity screen resizable via drag handles:
  - left/right pane width resizable (context ↔ editor ↔ navigation/feedback)
  - right sidebar split (navigation height ↔ tests/feedback height)
  - layout persists per-activity in localStorage (`codemm-activity-layout:v1:<activityId>`) (`apps/frontend/src/app/activity/[id]/page.tsx`).

### Iteration 30 (Examples: Required + Structured)

- Enforced at least 1 example per generated problem (`sample_inputs`/`sample_outputs` non-empty and same length) (`apps/backend/src/contracts/problem.ts`).
- Updated generator prompts to always include examples (fixed SQL prompt that previously suggested empty arrays) (`apps/backend/src/languages/*/prompts.ts`).
- Restyled the left “Examples” panel to a stacked “Sample input/output” card layout (closer to the desired structure) (`apps/frontend/src/app/activity/[id]/page.tsx`).

### Iteration 31 (Practice Activity: File Deletion + Full-Width Layout)

- Added a delete control on file tabs (only for files created via “+ File”; never deletes entry/readonly/problem-provided files) with a confirm modal (`apps/frontend/src/app/activity/[id]/page.tsx`).
- Reduced outer padding and removed the fixed max-width so the activity layout occupies the window edges more closely (left/right sidebars feel “full width”) (`apps/frontend/src/app/activity/[id]/page.tsx`).

### Iteration 32 (Repo Hygiene: Ignore Local `.env`)

- Added `.gitignore` rules to prevent committing `.env` / `.env.*` files while still allowing `.env.example` templates (`.gitignore`).

### Iteration 33 (Windows Dev: `npm` Spawn + Workspace Location)

- Fixed Windows dev failures where Electron couldn’t spawn the frontend because `spawn("npm", ...)` can’t resolve `npm.cmd` (`apps/ide/main.js`).
- Improved cross-platform env handling by updating the correct PATH key (`Path` on Windows) when prepending directories (`apps/ide/main.js`).
- Defaulted the dev workspace to the repo root when `CODEMM_WORKSPACE_DIR` is unset (keeps `.codemm/` inside `Codemm-Desktop/` instead of a parent folder); added `CODEMM_WORKSPACE_DATA_DIR` override to fully control the data dir (`apps/ide/main.js`).

### Iteration 34 (Dev Boot: Robust Frontend Spawn + Port Probe)

- Start the frontend dev server by spawning the Next.js CLI directly via Node (not via `npm run dev`), avoiding Windows `spawn npm ENOENT` issues and ensuring `-H 127.0.0.1` is applied consistently (`apps/ide/main.js`).
- Hardened frontend port selection by probing both IPv4 (`127.0.0.1`) and IPv6 loopback (`::1`) to avoid false “port is free” checks that can still lead to `EADDRINUSE` on `:::3000` (`apps/ide/main.js`).

### Iteration 35 (Generation Robustness: Contract Repair + Whitespace De-Brittling)

- Contract repair prompts are now clearly separated from Docker validation repair prompts (so “invalid test_suite” retries focus on fixing validation issues instead of “fix reference solution”) (`apps/backend/src/generation/perSlotGenerator.ts`).
- Added deterministic de-brittling for Java tests: trims leading/trailing whitespace in `assertEquals(" ... ", actual)` expected string literals, preventing repeated “brittle whitespace” rejections without wasting retries (`apps/backend/src/generation/perSlotGenerator.ts`).
- Reduced Windows `spawn EINVAL` risk by avoiding `detached: true` for piped child processes on Windows (still killed via `taskkill /T`) (`apps/ide/main.js`).

## Known Gaps / Next

- Renderer is still served from localhost (transitional); final target is to remove internal ports entirely.
- Packaging still needs end-to-end verification on macOS/Windows/Linux (build → install → run).
- Ollama auto-start/pull is best-effort and depends on a local Ollama install being present.
