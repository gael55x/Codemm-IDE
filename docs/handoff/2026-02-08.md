# Handoff: 2026-02-08

## Summary

- Continued Phase 3 (packaging + determinism hardening).
- Threads persistence is now explicitly `threads*` in SQLite (legacy `sessions*` workspaces migrate in-place on startup).
- Generation progress is replayable from persisted `runs`/`run_events` (not just in-memory buffers).

## Iteration Log

### Iteration 1 (IPC Hardening + Packaged Engine)

- Electron main adds zod-based IPC payload validation for `threads/*`, `activities/*`, and secrets (`apps/ide/main.js`).
- Electron main adds zod-based IPC payload validation for `judge/*` (`apps/ide/main.js`).
- Packaged runs force the engine to load compiled `dist` (`CODEMM_ENGINE_USE_DIST=1`) (`apps/ide/main.js`, `apps/backend/ipc-server.js`).

### Iteration 2 (Troubleshooting)

- Documented native module ABI mismatch fixes (`better-sqlite3`) and SQLite schema-init recovery (`docs/TROUBLESHOOTING.md`).

### Iteration 3 (Packaging Determinism)

- `npm run dist:mac` now rebuilds native deps for Electron automatically (`npm run rebuild:electron`) to avoid `better-sqlite3` ABI issues in packaged runs (`package.json`).

### Iteration 4 (Custom Instructions + Activities API)

- Persist per-thread `instructions_md` in `threads` (best-effort generation shaping; no secrets) (`apps/backend/src/database.ts`, `apps/backend/src/services/sessionService.ts`).
- Generation prompts now receive `customInstructionsMd` via prompt context across languages (`apps/backend/src/generation/index.ts`, `apps/backend/src/languages/*/prompts.ts`).
- Added engine RPC: `threads.setInstructions`, `activities.list` (summaries) (`apps/backend/src/ipcServer.ts`, `apps/backend/src/database.ts`).

### Iteration 5 (IDE Bridge)

- Exposed `threads.setInstructions` and `activities.list` via Electron IPC + preload allowlist (`apps/ide/main.js`, `apps/ide/preload.js`).

### Iteration 6 (Renderer UX)

- Added “Problem focus (optional)” instructions panel in chat UI (stored per-thread; used during generation) (`apps/frontend/src/app/page.tsx`).
- Added local “Your activities” page + header navigation (`apps/frontend/src/app/activities/page.tsx`, `apps/frontend/src/app/page.tsx`).
- Updated renderer docs to reflect IPC-only IDE-first flows (removed community/auth HTTP docs) (`apps/frontend/docs/*`).

### Iteration 7 (Docs)

- Documented new renderer APIs (`threads.setInstructions`, `activities.list`) and thread-level `instructions_md` (`apps/frontend/docs/api/frontend.md`, `docs/architecture/IDE_FIRST.md`).

### Iteration 8 (Renderer UX Polish)

- Restyled `/activities` to match the main app’s theme (dark mode, card styling, button styles) and added client-side search (`apps/frontend/src/app/activities/page.tsx`).

### Iteration 9 (Security Hardening)

- Mitigated localhost UI port hijacking by verifying an ephemeral frontend boot token via `GET /__codemm/health` before loading the renderer URL (`apps/ide/main.js`, `apps/frontend/src/app/__codemm/health/route.ts`, `docs/SECURITY.md`).

### Iteration 10 (README Refresh)

- Rewrote `README.md` to be an IDE-first documentation entrypoint (mental model, topology, persistence, security model, packaging, docs index).

### Iteration 11 (Judge Hardening)

- Ensured Java `/run` executes in Docker with network disabled and read-only rootfs (consistent with other languages) (`apps/backend/src/languages/java/run.ts`).

### Iteration 12 (Docs Hygiene)

- Updated `CONTRIBUTING.md` to reflect IPC-only engine (no Express/SSE) and IDE-first runtime (`CONTRIBUTING.md`).

### Iteration 13 (Local LLM + Electron Hardening)

- Added `ollama` as an LLM provider option (no API key; local model name) and wired it through secrets + engine provider selection (`apps/ide/main.js`, `apps/frontend/src/app/settings/llm/page.tsx`, `apps/backend/src/infra/llm/adapters/ollama.ts`).
- Hardened Electron renderer navigation (deny permission prompts; block navigations away from the expected local frontend origin; bind dev frontend to `127.0.0.1`) (`apps/ide/main.js`).

### Iteration 14 (Secrets Hardening)

- Stopped passing API keys to the engine via environment variables; Electron now configures the engine LLM provider in-memory via `engine.configureLlm` over IPC (`apps/ide/main.js`, `apps/backend/src/ipcServer.ts`, `apps/backend/src/infra/llm/runtimeConfig.ts`).

### Iteration 15 (Docs)

- Updated docs for Ollama + in-memory LLM configuration (`README.md`, `docs/FUNCTIONS.md`, `docs/TROUBLESHOOTING.md`).

### Iteration 16 (UX Copy)

- Renamed settings copy from “API key” to “LLM settings” where applicable (supports Ollama local provider) (`apps/frontend/src/app/settings/llm/page.tsx`, `apps/ide/main.js`).

## Known Gaps / Next

- API key changes still require restart (or a controlled engine restart + renderer resubscribe).
- Packaging still needs an end-to-end `.app` verification run on a machine with `electron-builder` available.
