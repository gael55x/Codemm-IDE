# Handoff: 2026-02-08

## Summary

- Continued Phase 3 (packaging + determinism hardening).
- Threads persistence is now explicitly `threads*` in SQLite (legacy `sessions*` workspaces migrate in-place on startup).
- Generation progress is replayable from persisted `runs`/`run_events` (not just in-memory buffers).

## Iteration Log

### Iteration 1 (IPC Hardening + Packaged Engine)

- Electron main adds zod-based IPC payload validation for `threads/*`, `activities/*`, and secrets (`apps/ide/main.js`).
- Electron main adds zod-based IPC payload validation for `judge/*` (`apps/ide/main.js`).
- Packaged runs force the engine to load compiled `dist` (`CODEMM_ENGINE_USE_DIST=1`) (`apps/ide/main.js`, `apps/backend/ipc-server.js`).

### Iteration 2 (Troubleshooting)

- Documented native module ABI mismatch fixes (`better-sqlite3`) and SQLite schema-init recovery (`docs/TROUBLESHOOTING.md`).

### Iteration 3 (Packaging Determinism)

- `npm run dist:mac` now rebuilds native deps for Electron automatically (`npm run rebuild:electron`) to avoid `better-sqlite3` ABI issues in packaged runs (`package.json`).

### Iteration 4 (Custom Instructions + Activities API)

- Persist per-thread `instructions_md` in `threads` (best-effort generation shaping; no secrets) (`apps/backend/src/database.ts`, `apps/backend/src/services/sessionService.ts`).
- Generation prompts now receive `customInstructionsMd` via prompt context across languages (`apps/backend/src/generation/index.ts`, `apps/backend/src/languages/*/prompts.ts`).
- Added engine RPC: `threads.setInstructions`, `activities.list` (summaries) (`apps/backend/src/ipcServer.ts`, `apps/backend/src/database.ts`).

### Iteration 5 (IDE Bridge)

- Exposed `threads.setInstructions` and `activities.list` via Electron IPC + preload allowlist (`apps/ide/main.js`, `apps/ide/preload.js`).

### Iteration 6 (Renderer UX)

- Added “Problem focus (optional)” instructions panel in chat UI (stored per-thread; used during generation) (`apps/frontend/src/app/page.tsx`).
- Added local “Your activities” page + header navigation (`apps/frontend/src/app/activities/page.tsx`, `apps/frontend/src/app/page.tsx`).
- Updated renderer docs to reflect IPC-only IDE-first flows (removed community/auth HTTP docs) (`apps/frontend/docs/*`).

### Iteration 7 (Docs)

- Documented new renderer APIs (`threads.setInstructions`, `activities.list`) and thread-level `instructions_md` (`apps/frontend/docs/api/frontend.md`, `docs/architecture/IDE_FIRST.md`).

## Known Gaps / Next

- API key changes still require restart (or a controlled engine restart + renderer resubscribe).
- Packaging still needs an end-to-end `.app` verification run on a machine with `electron-builder` available.
